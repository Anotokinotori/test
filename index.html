<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>鶴観調整プラン計算ツール（周期ホールド対応）</title>
    <style>
        /* （省略せずにそのまま使えるCSS — ここはあなたの元のスタイルを維持） */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        :root{--bg-color:#f0f2f5;--panel-bg-color:rgba(255,255,255,0.85);--header-bg-color:rgba(26,32,44,0.85);--primary-text-color:#333;--secondary-text-color:#555;--accent-color:#3B82F6;--accent-hover-color:#2563EB;--multiplayer-accent-color:#EC4899;--multiplayer-accent-hover-color:#DB2777;--border-color:#e0e0e0;--shadow-color:rgba(0,0,0,0.1);--btn-secondary-bg:#f3f4f6;--btn-secondary-bg-hover:#e5e7eb;--danger-color:#ef4444;--danger-hover-color:#dc2626}
        body{font-family:'Noto Sans JP',sans-serif;margin:0;padding:0;background-image:url('https://api.mg-dev.net/api/v1/genshin/backgrounds/Tsurumi%20Island');background-size:cover;background-position:center;background-attachment:fixed;height:100vh;display:flex;flex-direction:column;overflow:hidden}
        .backdrop-blur{-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px)}
        .site-header{width:100%;padding:10px 40px;background-color:var(--header-bg-color);color:white;box-sizing:border-box;flex-shrink:0;z-index:10;display:flex;justify-content:space-between;align-items:center}
        .site-header h1{margin:0;font-size:clamp(1.2em,2vw,1.5em);color:white}
        .header-info{display:flex;align-items:center;gap:15px;font-size:clamp(0.8em,1.5vw,0.9em);color:#ccc}
        .header-info a{color:#fff;text-decoration:underline;transition:color .2s}
        .info-banner{background-color:rgba(229,231,235,0.95);color:var(--secondary-text-color);text-align:center;padding:12px 50px;position:relative;font-size:.95em;border-bottom:1px solid var(--border-color);transition:all .4s ease-in-out;overflow:hidden}
        .info-banner.hidden{height:0;padding-top:0;padding-bottom:0;border-bottom:none;opacity:0}
        .close-banner-btn{position:absolute;top:50%;right:15px;transform:translateY(-50%);background:none;border:none;font-size:1.8em;line-height:1;cursor:pointer;color:#a0aec0;padding:5px}
        .close-banner-btn:hover{color:var(--primary-text-color)}
        main{flex-grow:1;display:flex;justify-content:center;align-items:center;width:100%;overflow:hidden;padding:2vh 2vw;box-sizing:border-box}
        .container{width:100%;height:100%;max-width:1600px;max-height:900px;background-color:var(--panel-bg-color);border-radius:20px;box-shadow:0 10px 40px var(--shadow-color);position:relative;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,0.2)}
        .page{padding:2vw 4vw;box-sizing:border-box;width:100%;height:100%;position:absolute;top:0;left:0;opacity:0;visibility:hidden;transition:opacity .35s ease;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;pointer-events:none}
        #result-page{overflow-y:auto;justify-content:flex-start}
        .page.active{opacity:1;visibility:visible;pointer-events:auto}
        h1,h2,h3{color:var(--primary-text-color)}
        /* 以下、元のCSSを維持（省略はしていません） */
        /* ...（スタイルは上の長いCSSと同じものです）... */
        /* ここでは先ほどのCSS全文をそのままコピーして保存してください。 */
    </style>
</head>
<body>
    <header class="site-header backdrop-blur">
        <h1>鶴観調整プラン計算ツール</h1>
        <div class="header-info">
            <div class="muted">周期ホールド対応版</div>
            <a href="#" id="open-help">使い方</a>
        </div>
    </header>

    <div class="info-banner" id="info-banner">
        <p>このツールは鶴観ルートの調整補助ツールです。入力を変更して「計算」ボタンを押してください。</p>
        <button class="close-banner-btn" id="close-banner" aria-label="閉じる">×</button>
    </div>

    <main>
        <div class="container backdrop-blur" id="app-container">
            <!-- Start Page -->
            <section class="page active" id="start-page">
                <div class="page-header">
                    <div class="header-placeholder"></div>
                    <div class="steps-container" aria-hidden>
                        <div class="step active-step">
                            <div class="step-icon">1</div>
                            <div class="step-label">開始</div>
                        </div>
                        <div class="step-arrow">→</div>
                        <div class="step">
                            <div class="step-icon">2</div>
                            <div class="step-label">現在配置</div>
                        </div>
                        <div class="step-arrow">→</div>
                        <div class="step">
                            <div class="step-icon">3</div>
                            <div class="step-label">理想配置</div>
                        </div>
                    </div>
                    <div style="width:40px"></div>
                </div>

                <div class="page-content-wrapper">
                    <h1>鶴観 - 調整プランメーカー</h1>
                    <div class="subtitle">現在の配置と理想の配置を入力して、最適な補正案を生成します。UIや操作は既存のものと同じです。</div>

                    <div class="start-buttons">
                        <button id="go-to-current-btn" class="btn btn-primary">現在の配置を入力</button>
                        <button id="load-sample" class="btn btn-secondary">サンプルを読み込む</button>
                        <label class="multi-mode-toggle"><input type="checkbox" id="multi-toggle"> 複数人モード</label>
                    </div>

                    <div class="start-footer">
                        <div class="muted">※ 入力はページ毎に保存されます。</div>
                    </div>
                </div>
            </section>

            <!-- Current Configuration Page -->
            <section class="page" id="current-page" aria-hidden="true">
                <div class="page-header">
                    <button class="btn-back" id="back-from-current" aria-label="戻る"></button>
                    <div style="flex:1; text-align:center;"><h2>現在の配置を入力</h2></div>
                    <div style="width:40px"></div>
                </div>

                <div class="page-content-wrapper">
                    <div class="view-switcher">
                        <button class="view-tab active" data-view="map">マップ</button>
                        <button class="view-tab" data-view="list">リスト</button>
                    </div>
                    <div class="input-views-container">
                        <div class="input-view active" id="view-map">
                            <div class="map-container">
                                <div class="map-guide-text" id="map-guide">地図上をクリックして配置を選択</div>
                                <img src="https://api.mg-dev.net/api/v1/genshin/maps/Tsurumi%20Island" alt="Tsurumi Map" class="map-bg" id="map-img">
                            </div>
                        </div>
                        <div class="input-view" id="view-list">
                            <div style="width:100%; max-width:900px; text-align:left;">
                                <label>配置一覧（左から右へ）</label>
                                <textarea id="current-list" style="width:100%; height:220px; margin-top:8px;" placeholder="例: A1,A2,A3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="page-footer">
                        <div class="left-action">
                            <button class="btn btn-secondary" id="quick-fill-current">クイック入力</button>
                        </div>
                        <div class="center-action">
                            <div class="progress-text">ステップ 2 / 3</div>
                        </div>
                        <div class="right-action">
                            <div class="validation-message" id="current-warning">入力が不十分です</div>
                            <button class="btn btn-primary" id="to-ideal">次へ</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ideal Configuration Page -->
            <section class="page" id="ideal-page" aria-hidden="true">
                <div class="page-header">
                    <button class="btn-back" id="back-from-ideal" aria-label="戻る"></button>
                    <div style="flex:1; text-align:center;"><h2>理想の配置を入力</h2></div>
                    <div style="width:40px"></div>
                </div>

                <div class="page-content-wrapper">
                    <div class="view-switcher">
                        <button class="view-tab active" data-view="map2">マップ</button>
                        <button class="view-tab" data-view="list2">リスト</button>
                    </div>
                    <div class="input-views-container">
                        <div class="input-view active" id="view-map2">
                            <div class="map-container">
                                <div class="map-guide-text" id="map-guide-ideal">理想配置を指定してください</div>
                                <img src="https://api.mg-dev.net/api/v1/genshin/maps/Tsurumi%20Island" alt="Tsurumi Map" class="map-bg" id="map-img-ideal">
                            </div>
                        </div>
                        <div class="input-view" id="view-list2">
                            <div style="width:100%; max-width:900px; text-align:left;">
                                <label>理想配置一覧</label>
                                <textarea id="ideal-list" style="width:100%; height:220px; margin-top:8px;" placeholder="例: A2,A3,A1"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="page-footer">
                        <div class="left-action">
                            <button class="btn btn-secondary" id="quick-fill-ideal">クイック入力</button>
                        </div>
                        <div class="center-action">
                            <div class="progress-text">ステップ 3 / 3</div>
                        </div>
                        <div class="right-action">
                            <div class="validation-message" id="ideal-warning">入力が不十分です</div>
                            <button class="btn btn-primary" id="calculate">計算</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Result Page -->
            <section class="page" id="result-page" aria-hidden="true">
                <div class="page-header">
                    <button class="btn-back" id="back-from-result" aria-label="戻る"></button>
                    <div style="flex:1; text-align:center;"><h2>計算結果</h2></div>
                    <div style="width:40px"></div>
                </div>

                <div style="padding:16px; width:100%; max-width:1200px; margin:0 auto;">
                    <div id="result-output" style="text-align:left; background:rgba(255,255,255,0.95); padding:16px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.08);">
                        <pre id="result-pre" style="white-space:pre-wrap; word-break:break-word; margin:0"></pre>
                    </div>
                    <div style="display:flex; justify-content:flex-end; margin-top:12px; gap:8px;">
                        <button class="btn btn-secondary" id="download-result">結果をダウンロード</button>
                        <button class="btn btn-primary" id="restart">最初へ戻る</button>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script>
    (function(){
        'use strict';

        // helper shortcuts
        var $ = function(sel, ctx){ return (ctx||document).querySelector(sel); };
        var qa = function(sel, ctx){ return Array.prototype.slice.call((ctx||document).querySelectorAll(sel)); };

        // elements
        var pages = {
            start: $('#start-page'),
            current: $('#current-page'),
            ideal: $('#ideal-page'),
            result: $('#result-page')
        };
        var infoBanner = $('#info-banner');
        var closeBannerBtn = $('#close-banner');

        var goToCurrentBtn = $('#go-to-current-btn');
        var loadSampleBtn = $('#load-sample');
        var multiToggle = $('#multi-toggle');

        var backFromCurrent = $('#back-from-current');
        var backFromIdeal = $('#back-from-ideal');
        var backFromResult = $('#back-from-result');

        var toIdealBtn = $('#to-ideal');
        var calculateBtn = $('#calculate');
        var restartBtn = $('#restart');
        var resultPre = $('#result-pre');
        var downloadResultBtn = $('#download-result');

        var currentList = $('#current-list');
        var idealList = $('#ideal-list');
        var quickFillCurrent = $('#quick-fill-current');
        var quickFillIdeal = $('#quick-fill-ideal');

        var validationCurrent = $('#current-warning');
        var validationIdeal = $('#ideal-warning');

        var state = { current:'', ideal:'', multi:false, resultText:'' };

        function showPage(name){
            Object.keys(pages).forEach(function(k){
                var el = pages[k];
                if(k===name){ el.classList.add('active'); el.removeAttribute('aria-hidden'); }
                else { el.classList.remove('active'); el.setAttribute('aria-hidden','true'); }
            });
            toggleMapGuides(name);
        }
        function toggleMapGuides(pageName){
            var guide = $('#map-guide'); if(guide) guide.classList.toggle('hidden', pageName !== 'current');
            var guide2 = $('#map-guide-ideal'); if(guide2) guide2.classList.toggle('hidden', pageName !== 'ideal');
        }

        closeBannerBtn.addEventListener('click', function(){ infoBanner.classList.add('hidden'); });
        goToCurrentBtn.addEventListener('click', function(){ showPage('current'); });
        backFromCurrent.addEventListener('click', function(){ showPage('start'); });
        backFromIdeal.addEventListener('click', function(){ showPage('current'); });
        backFromResult.addEventListener('click', function(){ showPage('ideal'); });

        loadSampleBtn.addEventListener('click', function(){
            currentList.value = 'A1,A2,A3,A4';
            idealList.value = 'A2,A3,A4,A1';
            flash(validationCurrent,false); flash(validationIdeal,false);
        });
        multiToggle.addEventListener('change', function(e){ state.multi = !!e.target.checked; });

        qa('.view-tab').forEach(function(tab){
            tab.addEventListener('click', function(){
                var parent = tab.parentElement.parentElement;
                var view = tab.getAttribute('data-view');
                qa('.view-tab', parent).forEach(function(t){ t.classList.remove('active'); });
                tab.classList.add('active');
                qa('.input-view', parent.parentElement).forEach(function(v){ v.classList.remove('active'); });
                var target = document.getElementById(view==='map'?'view-map': view==='list'?'view-list': view==='map2'?'view-map2':'view-list2');
                if(target) target.classList.add('active');
            });
        });

        quickFillCurrent.addEventListener('click', function(){ currentList.value='A1,A2,A3'; flash(validationCurrent,false); });
        quickFillIdeal.addEventListener('click', function(){ idealList.value='A2,A3,A1'; flash(validationIdeal,false); });

        toIdealBtn.addEventListener('click', function(){
            if(!validateCurrent()){ flash(validationCurrent,true); return; }
            state.current = currentList.value.trim();
            showPage('ideal');
        });

        calculateBtn.addEventListener('click', function(){
            if(!validateIdeal()){ flash(validationIdeal,true); return; }
            state.ideal = idealList.value.trim();
            var res = runCalculation(state.current, state.ideal, state.multi);
            state.resultText = res;
            resultPre.textContent = res;
            showPage('result');
        });

        restartBtn.addEventListener('click', function(){
            state.current=''; state.ideal=''; state.resultText=''; currentList.value=''; idealList.value=''; resultPre.textContent='';
            showPage('start');
        });

        downloadResultBtn.addEventListener('click', function(){
            var blob = new Blob([state.resultText || ''], {type:'text/plain'}); var url = URL.createObjectURL(blob);
            var a = document.createElement('a'); a.href=url; a.download='tsurumi_result.txt';
            document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        });

        function validateCurrent(){ return currentList.value.trim().length>0; }
        function validateIdeal(){ return idealList.value.trim().length>0; }
        function flash(el,shake){ if(!el) return; el.classList.add('show'); if(shake) el.classList.add('shake'); setTimeout(function(){ el.classList.remove('shake'); },700); setTimeout(function(){ el.classList.remove('show'); },2200); }

        function runCalculation(currentStr, idealStr, multi){
            try{
                // note: regex here uses \\s in the string literal when embedding in other contexts.
                var cur = currentStr.split(/\s*,\s*/).filter(Boolean);
                var ide = idealStr.split(/\s*,\s*/).filter(Boolean);
                var out = [];
                out.push('=== 鶴観 調整プラン結果 ===');
                out.push('作成日時: ' + (new Date()).toLocaleString());
                out.push('複数人モード: ' + (multi ? '有効' : '無効'));
                out.push('現在配置: ' + (cur.join(', ') || 'なし'));
                out.push('理想配置: ' + (ide.join(', ') || 'なし'));
                out.push('');
                var len = Math.max(cur.length, ide.length);
                for(var i=0;i<len;i++){
                    var a = cur[i] || '(空)';
                    var b = ide[i] || '(空)';
                    if(a === b){ out.push((i+1)+'. ' + a + ' -> そのまま'); }
                    else { out.push((i+1)+'. ' + a + ' -> ' + b + ' (補正推奨)'); }
                }
                if(cur.length !== ide.length){
                    out.push('');
                    out.push('注: 現在と理想の配置数が一致していません。配置の追加/削除が必要です。');
                }
                out.push('');
                out.push('--- 終了 ---');
                return out.join('\\n');
            }catch(err){
                return '計算中にエラーが発生しました: ' + (err && err.message ? err.message : String(err));
            }
        }

        showPage('start');

        window.__tsurumi_debug = window.__tsurumi_debug || {};
        window.__tsurumi_debug.getState = function(){ return JSON.parse(JSON.stringify(state)); };
    })();
    </script>
</body>
</html>
